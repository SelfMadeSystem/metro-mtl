---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import LineBadge from "../components/LineBadge.astro";
import StationButton from "../components/StationButton.astro";
import type { Station } from "../content.config";
import { LineList } from "../components/LineList.tsx";

const stations = (await getCollection("stations")).map((s) => s.data);
const lines = (await getCollection("lines")).map((s) => s.data);
const lineById = Object.fromEntries(lines.map((line) => [line.id, line]));
const stationsByLine = lines.reduce(
  (acc, line) => {
    // Sorted by index in line.data.stations
    acc[line.id] = stations
      .filter((station) => station.lines.some(({ id }) => id === line.id))
      .sort(
        (a, b) =>
          line.stations.findIndex((s) => s.id === a.id) -
          line.stations.findIndex((s) => s.id === b.id)
      );
    return acc;
  },
  {} as Record<string, Station[]>
);
---

<Layout>
  <h1 class="text-3xl font-bold mb-6 text-center mt-8">
    Metro Montr√©al Stations
  </h1>
  <div class="flex justify-between flex-wrap mx-8 gap-8">
    {
      lines.map((line) => (
        <LineList
          line={line}
          lineById={lineById}
          stationsByLine={stationsByLine}
          client:load
        />
      ))
    }
  </div>
</Layout>
