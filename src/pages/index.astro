---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import StationSearch from "../components/StationSearch";
import type { Station } from "../content.config";

const stations = (await getCollection("stations")).map((s) => s.data);
const lines = (await getCollection("lines")).map((s) => s.data);
const lineById = Object.fromEntries(lines.map((line) => [line.id, line]));
const stationsByLine = lines.reduce(
  (acc, line) => {
    // Sorted by index in line.data.stations
    acc[line.id] = stations
      .filter((station) => station.lines.some(({ id }) => id === line.id))
      .sort(
        (a, b) =>
          line.stations.findIndex((s) => s.id === a.id) -
          line.stations.findIndex((s) => s.id === b.id)
      );
    return acc;
  },
  {} as Record<string, Station[]>
);
---

<Layout>
  <div class="min-h-screen bg-map">
    <h1 class="text-3xl font-bold mb-6 text-center pt-8">
      Metro Montr√©al Stations
    </h1>
    <div class="flex flex-wrap justify-center gap-8">
      <a
        href="/svgs/planmetropolitain.svg"
        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
        >View Metropolitan Map</a
      >
      <a
        href="/svgs/a-plan-metro-noir.svg"
        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
        >View Metro Map</a
      >
    </div>
    <StationSearch client:load {stations} {lines} {lineById} {stationsByLine} />
  </div>
</Layout>
